name: Build Wheels

on: [push, workflow_dispatch]

jobs:
  build_wheels:
    name: Build for ${{ matrix.rid }}
    runs-on: ubuntu-latest  # 使用 Linux 即可编译所有平台的 .NET DLL
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: Windows
            rid: win-x64
            whl_tag: win_amd64
          - os_name: Linux
            rid: linux-x64
            whl_tag: manylinux_2_17_x86_64.manylinux2014_x86_64
          - os_name: macOS-Intel
            rid: osx-x64
            whl_tag: macosx_10_15_x86_64
          - os_name: macOS-ARM64
            rid: osx-arm64
            whl_tag: macosx_11_0_arm64

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install uv
      uses: astral-sh/setup-uv@v2

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # 1. 针对特定架构发布 (RID)
    - name: Publish DLLs for ${{ matrix.rid }}
      run: |
        cd osu-tools/PerformanceCalculator
        # 使用 -r 指定具体架构，确保只下载该架构的原生库
        dotnet publish -c Release -r ${{ matrix.rid }} --no-self-contained -o ../../compiled_dlls

    # 2. 注入文件并精简体积
    - name: Inject and Prune
      run: |
        mkdir -p src/osu_lib/lib
        cp -r compiled_dlls/* src/osu_lib/lib/
        
        # 删除不必要的文件
        rm -f src/osu_lib/lib/*.pdb
        rm -f src/osu_lib/lib/*.exe
        rm -f src/osu_lib/lib/osu.Game.Resources.dll
        
        echo "=== ${{ matrix.rid }} Final Size ==="
        du -sh src/osu_lib/lib

    # 3. 构建 Wheel 并重命名平台标签
    - name: Build and Tag Wheel
      run: |
        uv build
        cd dist
        ORIGINAL_WHL=$(ls *.whl)
        # 将 any 替换为 matrix 中定义的 whl_tag
        NEW_WHL="${ORIGINAL_WHL//any/${{ matrix.whl_tag }}}"
        mv "$ORIGINAL_WHL" "$NEW_WHL"
        echo "Generated wheel: $NEW_WHL"

    # 4. 上传产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.rid }}
        path: dist/*.whl